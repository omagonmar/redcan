.help qsky November2011 gemini.quirc
.ih
NAME
qsky -- Derive sky image for QUIRC, includes flagging of objects
.ih
USAGE
qsky inimages outimage
.ih
PARAMETERS
.ls inimages 
Images to combine.  \fIinimages\fR can be a comma-separated 
list of image names or defined by using the * wild card.  QSKY also 
accepts @filename to point to a file containing the names of the 
input images.
.le
.ls outimage
Output sky image.
.le
.ls outtitle = "default"
The outtitle string will be written in the output image header 
under the keyword specified by the i_title (see help page for
HEDIT).  If \fIouttitle\fR="default" or \fIouttitle\fR=""", 
QSKY will write
"SKY IMAGE from gemini.quirc.qsky" in the output image header.
The i_title of the output mask file will be set to
"BPM for"//i_title, where i_title is either the 
default string or a specifically given string.
.le
.ls combtype = "default" (default|median|average)
Type of combination operation to be used by IMCOMBINE after
all the stars have been removed from each image.  The default is
"average".  Note that \fIcombtype\fR="default" overrides the setting 
of \fIrejtype\fR below.
.le
.ls rejtype = "avsigclip" (none|avsigclip|minmax)
Type of rejection algorithm to be used by IMCOMBINE. 
If \fIcombtype\fR = "default" and the number of files is 3 or more,
the reject type will be set to "avsigclip", regardless of
how \fIrejtype\fR is set.  If only two images are specified, they are
combined by taking the minimum of the two.
.le
.ls logfile = ""
Name of logfile. If empty, then the package logfile (\fIquirc.logfile\fR) is 
used. If neither is defined, then \fIlogfile\fR=quirc.log is used.
.le
.ls nlow = 0
Number of low pixels to reject, when using \fIrejtype\fR="minmax".
.le
.ls nhigh = 1
Number of high pixels to reject, when using \fIrejtype\fR="minmax".
.le
.ls lsigma = 3., hsigma = 3.
Number of multiples of sigma (lower and higher) for rejection using
IMCOMBINE.
.le
.ls threshold = 4.5
Threshold in sigma for object detection by DAOFIND.  This 
parameter can be tuned to balance between finding faint objects and
triggering on spurious noise peaks.
.le
.ls fwhmpsf = 4.0
Estimate of the PSF FWHM in pixels.  This number will be replaced by
the measured value using GEMSEEING if \fIfl_gemseeing\fR=yes.
.le
.ls rebin = 7.0
Images will be binned by a factor of int(rebin/2) if \fIfwhmpsf\fR
is larger than this value.  The purpose of binning is to allow 
DAOFIND to run faster.  The output sky image is not binned.
.le
.ls datamax = 50000.
Maximum good data level for the input images (saturation level).
.le
.ls key_ron = "RON"
Header keyword for detector read noise.
.le
.ls key_gain = "GAIN"
Header keyword for detector gain (e-/ADU).
.le
.ls ron = 15.
Default read noise (e-) to be used if the header keyword
specified by \fIkey_ron\fR is not found or is empty.
.le
.ls gain = 1.85
Default gain (e-/ADU) to be used if the header keyword specified by 
\fIkey_gain\fR is not found or is empty.
.le
.ls key_exptime = "EXPTIME"
Header keyword for the exposure time.
.le
.ls key_filter = "FILTER"
Header keyword for the filter used.
.le
.ls key_airmass = "AIRMASS"
Header keyword for the airmass.
.le
.ls masksuffix = "msk"
QSKY produces an object mask for each input image.  The names of these
images are the input image names + \fImasksuffix\fR.
.le
.ls maskfactor = 1.
This parameter allows the user to tune the size of the holes chopped
out around each star.  The nominal radius as computed by QSKY 
will be scaled by \fImaskfactor\fR in constructing the mask.
.le
.ls fl_keepmasks = no
If set to yes, the object masks for each input image will not be deleted.
The mask files will have the input image names with the suffix defined
by the parameter \fImasksuffix\fR.
.le
.ls fl_gemseeing = no
If \fIfl_gemseeing\fR=yes, GEMSEEING will be run to improve the 
determination of the FWHM of the PSF in each input image. 
If \fIfl_gemseeing\fR=no, the input value of \fIfwhmpsf\fR will be used.
.le
.ls verbose = no
Print actions to the screen.
.le
.ls status
This flag is non-zero after execution of QSKY if a fatal error was
encountered.
.le
.ih
DESCRIPTION
.le
QSKY constructs a sky image from a list of input images.  It does
so by first running QFASTSKY to generate a simple median
sky image, which it uses to reduce the input sky images.  
A flat field is generated by normalizing this quick sky image
if the signal is sufficiently strong to justify doing so (i.e., the noise
in the flat field is less than 2%). The
input images, sky subtracted and flattened, are then rebinned if the 
estimated PSF FWHM as specified by the user (\fIfwhmpsf\fR) exceeds 
\fIrebin\fR (in pixels).  The purpose of this is to allow DAOFIND
to run more efficiently.  After rebinning, if necessary, QSKY calls
GEMSEEING to get a better seeing FWHM for each image.  If 
GEMSEEING fails or \fIfl_gemseeing\fR=no, the input value 
\fIfwhmpsf\fR is used instead.  

DAOFIND is then run to identify
all objects in the field.  QSKY then calls \fIskymask\fR to generate
a mask of the objects.  Finally, IMCOMBINE is called with the
appropriate input parameters and masks to generate the final sky image 
(average by default) with the stars masked.
If there are bad pixel masks specified in the headers of the input
files (header keyword BPM), they are included in the object masks passed 
to IMCOMBINE.
QSKY creates an output bad pixel mask (as specified in the output
header keyword QSKYMASK) that flags any empty pixels in the output
sky image.  If there are overlapping regions that are removed from
every single input sky image, they will show up as regions of bad pixels
in the output mask.  If no bad pixel masks were specified in the BPM
header keyword of the input images, the output mask should ideally be 
empty, indicating that there were no empty regions in the final combined
sky image.

With \fIcombtype\fR="default" the final image is always combined using
the average.  If only two files are being combined, the minimum is
used (i.e., \fIreject\fR="minmax" and \fInhigh\fR=1); 
otherwise \fIreject\fR="avsigclip" is used to remove cosmic rays from
individual sky images.  The type of combining and rejection can be
controlled by changing the input QSKY parameters.
QSKY (through the call to QFASTSKY) warns the user if exposure times 
differ by more than 0.1 sec.

After processing the header of the output image is updated with
information about the processing. The following keywords are added
or updated.

.nf
Keyword   Explanation
--------  ------------
GEM-TLM   Time of the last modification done with the GEMINI package
QSKY      Time of processing with QSKY
QSKYCOMB  QSKY combination type
QSKYREJE  QSKY rejection type
QSKYNLOW  QSKY number of low pixels rejected (QSKYCOMB=minmax)
QSKYNHIG  QSKY number of high pixels rejected (QSKYCOMB=minmax)
QSKYLSIG  QSKY low sigma rejection (QSKYCOMB=avsigclip)
QSKYHSIG  QSKY high sigma rejection (QSKYCOMB=avsigclip)
QSKYIM1   First image used. One keyword is added for each image used.
  ...
QSKYMASK  Output bad pixel mask for the output image.
.fi

.le
.ih
EXAMPLES

1. To combine a list of images to a sky image

.nf
      cl> qsky image1,image2,image3,image4,image5 skyimage fwhmpsf=4.5
.fi

2. To combine a list of images given in the file inputfile to a 
sky image without determining the seeing for each image

.nf
      cl> qsky @inputfile skyimage fwhmpsf=4.5 fl_gemseeing-
.fi

3. To combine all fits images starting with "q" in the current directory
to a sky image, and to chop out a slightly larger region around each star
(saving the mask files for later examination):

.nf
      cl> qsky q*fits skyimage fwhmpsf=4.5 maskfactor=1.5 fl_keepmasks+
.fi

.ih
KNOWN BUGS AND LIMITATIONS
GEMSEEING occasionally crashes with a "Floating point exception" due
to negative flux profiles fitted for faint objects. This bug originates
from NOAO.OBSUTIL.PSFMEASURE. If this happens, QSKY hangs and never returns 
from the GEMSEEING call. To work around the bug set \fIthreshold\fR 
higher to avoid including noise peaks as objects, or use QSKY with 
\fIfl_gemseeing\fR=no.
.ih
SEE ALSO
qfastsky, gemseeing, daofind, skymask, imcombine
.endhelp
