.help gfextract October2014 gemini.gmos
.ih
NAME
gfextract -- Extract GMOS IFU spectra with optional correction for 
lenslet/fiber throughput
.ih
USAGE   
gfextract inimage
.ih
PARAMETERS
.ls inimage
Input GMOS IFU MEF image.  Lists and wildcards are not supported.  
The input image should be a MEF file and have been processed by GPREPARE and 
GIREDUCE.
.le
.ls outimage = ""
Name of output MEF file.
See GMOSINFOIFU for information about the number of extensions in the
output image for images taken in IFU 2-slit mode and in IFU 1-slit mode.
\fIoutimages\fR has precedence over \fIoutpref\fR.
.le
.ls outpref = "e"
Prefix for output images. Names of output images will be the names of
the input images with the prefix attached. \fIoutpref\fR is used
if \fIoutimages\fR="". 
.le
.ls title = ""
Image title for the science extensions.
.le
.ls reference = ""
Name of the reference file to use for defining apertures and traces.
.le
.ls response = ""
Name of the lenslet/fiber throughput file generated by GFRESPONSE.
.le
.ls exslits = "*" (red|blue|*)
Slit(s) to extract (* for the slit(s) defined in the MDF). For 2-slit mode,
this option allows each slit to be extracted separately over its full, clean
spectral range, instead of just the range common to both slits. This splits
the IFU field in two, but allows for non-standard grating and filter
configurations. Any overlap between slits is still removed unless
\fIfl_novlap\fR=no. This parameter should only be used when center of filter
does not match desired central wavelength. This only occurs in extreme cases.
.le
.ls line = INDEF
Column used for finding apertures.  If INDEF then the center of the spectrum 
is used.
.le
.ls nsum = 10
The number of columns summed for finding apertures.
.le
.ls trace = yes
Trace spectra.
.le
.ls recenter = yes
Recenter apertures.
.le
.ls thresh = 200.
Detection threshold for profile centering (GFEXTRACT).
.le
.ls function = "chebyshev" (chebyshev|spline1|spline3|legendre)
Function to be used for fitting the trace. 
.le 
.ls order = 5
Order for the trace fit.
.le
.ls t_nsum = 10
The number of dispersion lines to sum for the trace.
.le
.ls weights = "variance" (variance|none)
Weighting used during extraction. It is recommended that "none" be used,
since the historical default of "variance" is not optimized for overlapping
IFU spectra and can lead to extraction artifacts at low S/N or in the
presence of cosmic rays.
.le
.ls bpmfile = "gmos$data/chipgaps.dat"
Bad-pixel mask for column interpolation, used by GMOSAIC.
.le
.ls grow = 1.0
Number of pixels by which to grow the chip gaps when re-interpolating them
(\fIfl_fixgaps\fR=yes).
.le
.ls gaindb = "default"
Database file containing the GMOS gain data. The default value for \fIgaindb\fR
is gmos$data/gmosamps.dat.
.le
.ls gratingdb = "gmos$data/GMOSgratings.dat"
Database file with GMOS grating information.
.le
.ls filterdb = "gmos$data/GMOSfilters.dat"
Database file with GMOS filter information.
.le
.ls xoffset = INDEF
The offset in the X (wavelength) direction between the theoretically 
predicted position of the spectra and the actual position.  The units are 
nanometers.  This overrides the offset value in \fIgratingdb\fR if it
is not equal to INDEF.
.le
.ls perovlap = 10.
If \fIfl_novlap\fR=yes, then the calculated lengths of the spectra are
shortened by this percentage to minimize any remaining overlap (GFEXTRACT).
.le
.ls sci_ext = "SCI"
Name of the MEF extension containing the science data.
.le
.ls var_ext = "VAR"
Name of the MEF extensions containing the variance frame.
.le
.ls dq_ext = "DQ"
Name of the MEF extensions containing the data quality array.
.le
.ls fl_inter = no
If yes, then APALL is run interactively.
.le
.ls fl_vardq = no
Extract the variance and data quality planes.  
.le
.ls fl_novlap = yes
In two-slit mode, extract only non-overlapping sections of spectra
from each slit (no overlap).  If \fIfl_novlap\fR=no then the entire
length of each slit allowed by the filter is extracted, regardless of
overlap.
.le
.ls fl_gnsskysub = no
Subtract sky from nod&shuffle images using GNSSKYSUB.
.le
.ls fl_fixnc = no
Auto-correct for nod count mismatch in nod&shuffle observations (GNSSKYSUB).
.le
.ls fl_fixgaps = no
Re-interpolate the chip gaps after extraction, before flat fielding with
\fIresponse\fR (where applicable)? For optimal results, the \fIresponse\fR
file itself should have been extracted with the same value of this option.
This option is ignored if \fIfl_vardq\fR=no, since the gap locations are
tracked in the DQ plane.
.le
.ls fl_gsappwave = yes
Run GSAPPWAVE to apply a preliminary wavelength solution.
.le
.ls fl_fulldq = no
Passed to GMOSAIC if data are not mosaiced already. Setting \fIfl_fulldq\fR=yes
will decompose the \fIdq_ext\fR extensions into their constituent bits before
transforming them. The pixels in the individually transformed bit planes are
then checked against the multiple of \fIdqthresh\fR times the bit value. Pixel
values in the individual bit planes greater than this value are then set to the
current bit value, less than this value the pixel values are set to 0, i.e.,
good. Once this is done for all bit values in the original \fIdq_ext\fR
extension, the newly transformed and thresholded bit planes are combined by a
bitwiseOR to form the output \fIdq_ext\fR extension. This is only done for CCDs
1 and 3. In addition, pixels that are created during the transformation, i.e,
output pixels that lie outside of the dimensions of the input plane are flagged
with a bit value of 16. It is recommended to set \fIfl_fulldq\fR=yes as this
will retain \fIdq_ext\fR information correctly.
.le
.ls dqthresh = 0.1 (min=0.0, max=0.5)
Fractional threshold to apply and flag pixels as contaminated with the current
bit value when decomposing \fIdq_ext\fR extensions (\fIfl_fulldq\fR=yes).
.le
.ls logfile = ""
Name of the logfile. The default value makes the task use the logfile
defined by gmos.logfile.
.le
.ls verbose = yes
Print actions to the screen.
.le
.ls status = 0
Exit status will be non-zero if the procedure halted with an error.
This parameter is always set by the task, and should not be modified by
the user.
.le

.ih 
DESCRIPTION 

GFEXTRACT extracts spectra from a GMOS IFU image.  Currently lists of
input images are not accepted. Multiple images can be processed using
GFREDUCE which will then call GFEXTRACT. This is the preferred method
of running GFEXTRACT.  The input image should include a MDF extension
and have been trimmed and bias/overscan subtracted.  Optionally, the
input image can be cleaned of cosmic rays by GSCRREJ or mosaiced with
GMOSAIC.  If the input image has not been mosaiced, then GFEXTRACT
will call GMOSAIC.

The field-to-slit mapping of the GMOS-S IFU allows the use of the
nod&shuffle (N&S) observing mode for improved sky subtraction,
especially in the red. Sky subtraction for N&S data can be done in two
ways.  GNSSKYSUB can be called by setting \fIfl_gnsskysub\fR="yes".
If data were taken at multiple DTA X positions but the same spatial
position then images can be combined and the sky can be subtracted
using GNSCOMBINE.  In this case the spectra should be gprepared,
bias-subtracted, and processed by GNSCOMBINE before running GFEXTRACT
to do the extraction.

The image sections corresponding to each slit are calculated using the
information in the MDF extension added by GPREPARE, the binning of the
CCDs, the characteristics of the grating and filter used, the optical
characteristics of GMOS, and the number of IFU slits used.  It has
been found that the offsets between the theoretical predictions and
the actual spectra can change with time, especially for the B600
grating in GMOS-N.  This was due to a mechanical problem in some
grating cells in GMOS-N which was repaired in the last half of
2003. Other shifts can be the result of errors in the GMOS grating
tilt calibrations.  In any data for which a bulk offset in the
dispersion direction is suspected, the output central wavelengths
should be checked using GCAL arcs.  The default offsets can be
overridden using the \fIxoffset\fR parameter, which has units of
nanometers and should be set such that running GSAPPWAVE gives a
reasonable wavelength solution.

The extraction is currently done with APALL, summing pixels within
+/-2.5 pixels of the center of each fiber.  Various APALL parameters
(\fIline\fR, \fInsum\fR, \fItrace\fR, ...) for finding and tracing the
apertures can be set.  Previously extracted spectra (typically a GCAL
flat) can be used as a \fIreference\fR for extracting arcs or objects
with weak continua that are difficult to trace.  If a file of relative
fiber throughputs (\fIresponse\fR) generated by GFRESPONSE is
provided, then it is used to apply flat-fielding and throughput
correction.  If \fIfl_gsappwave\fR=yes, then GFEXTRACT calls GSAPPWAVE
in order to add a simple wavelength solution to the header.

GFEXRACT adds a new column, APID, to the MDF table of the output file
which corresponds to the aperture id from APALL in the extension
headers.  These numbers, not the lenslet number (NO) should be used for
matching spectral aperture numbers with MDF rows.  In the MDF a bad or
unextractable lenslet (BEAM=-1) will have APID=0.  In two-slit mode
the APID counter restarts at 1 at lenslet 751 (the first spectrum in
the blue slit) in order to match the headers since the extractions of
the two slits are done independently.

As of v1.50 (Sept. 2014), the previous variance and data quality
calculations, based on output statistics from APALL, have been replaced with
a direct propagation of the input variance and DQ, extracted in the same
way as the science data. The previous method only worked with
\fIweights\fR="variance" (which as noted below can cause artifacts),
caused loss of data quality information, sometimes produced noisy variance
results, based on differences between input spectra rather than the total
counts, and may have been scaling the variance incorrectly. The new method
can produce worse variance results than the old one when using
\fIweights\fR="variance", again due to extraction artifacts, but it is now
recommended to avoid that option.

.ih
EXAMPLES

1. Extract spectra from a GCAL flat interactively.

.nf
    cl> gfextract rgN20010908S092  fl_inter+
.fi

2. Extract arc using a flat as a reference. Specify the output file.

.nf
    cl> gfextract rgN20010908S093 outimage=ergN20010908S093_092 \
    >>> reference=ergN20010908S092 trace- recenter-
.fi

.ih
BUGS AND LIMITATIONS
Running GFEXTRACT with weights="variance" has been seen to produce
artificial spikes and background variations in low signal-to-noise data;
setting weights="none" will solve this problem.

.ih
SEE ALSO
gmosinfoifu, gfresponse, gfreduce, apall
.endhelp
