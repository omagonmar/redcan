.help nfprepare December2011 gemini.nifs
.ih
NAME
nfprepare --  Prepare NIFS data for reduction
.ih
USAGE
nfprepare inimages
.ih
PARAMETERS
.ls inimages  
Filenames for unprocessed data in the fits format, as generated by the
instrument.  \fIinimages\fR may be given as a comma separated list, a
@filelist, or using wildcards.
.le
.ls rawpath = ""
A path to a directory where the \fIinimages\fR are found.  This
parameter allows NFPREPARE to be run in a new, empty directory,
copying the data required from an archive directory.
.le
.ls outimages = ""
A list of output image names.  The list must contain as many names as
appear in \fIinimages\fR.  If this parameter is empty then
\fIoutprefix\fR is used instead.
.le
.ls outprefix = "n"
Prefix for output images.  If \fIoutimages\fR is not given, then this
parameter is used to construct the names of the output images from the
names of the input images.
.le
.ls bpm = ""
A mask file to flag known bad pixels in the detector.  A suitable file
is generated by NSFLAT.
.le
.ls fl_vardq = yes 
Should variance and data quality extensions be generated?  Other tasks
in the gemini packages attempt to maintain these values.  They appear
as fits extensions with names VAR and DQ.
.le
.ls fl_cravg = no
Attempt to flag cosmic ray and radiation events using the
noao.imred.crutil task.  The parameters are tuned to detect the
radiation events generated by the short camera lens coating, but
results are only partially successful because these events persist
over time, decaying slowly, and so become too small to be reliably
detected, even though they may still affect data.
.le
.ls crradius = 0
Growth radius for bad pixels.  This allows pixels neighbouring those
classified as cosmic rays or radiation events to be excluded from
analysis.  Used only if \fIfl_cravg\fR is selected.
.le
.ls fl_dark_mdf = no
Force the attachment of an MDF to dark frames.  The MDF describes how
to cut the data (e.g., to discard data outside the slit, or isolate a
particular cross-dispersed order) and the selection of an MDF is based
on various header parameters (see \fIconfigtable\fR).
.sp
Since the same dark frames may be used for a variety of different
configurations they typically do not have an instrument configuration
that will determine the "correct" MDF.  So it is normally not useful
to associate an MDF with a dark frame in NFPREPARE.
.sp
Dark frames without MDF data will be handled correctly by NSREDUCE and
NSFLAT - the MDF from the data being reduced will be used if required.
.le
.ls fl_subtract = yes
Subtract off the reference pixel level.
.le
.ls fl_correct = no
Correct for data non-linearity.  This uses the task irred.irlincor and
the coefficients defined in \fIarraytable\fR.
.le
.ls fl_saturated = yes
Flag saturated pixels in the DQ array 
(if \fIfl_vardq\fR=yes).
.le
.ls fl_nonlinear = no
Flag non-linear pixels in the DQ array 
.le
.ls arraytable = "nifs$data/nifsarray.fits"
The table that defines, for any particular bias level (column bias
(V)), the following array related parameters: readnoise and gain
(columns readnoise (electrons) and gain (electrons/ADU)); well depth
(column well (adu)), linearlimit and nonlinearlimit (columns
linearlimit and nonlinearlimit (fraction of well)); coefficients for
non-linear correct (columns coeff1, coeff2 and coeff3).
.sp
Bias is determined using \fInsheaders.key_bias\fR header value.
.le
.ls configtable = "nifs$data/nifsconfig.fits"
The table that defines which MDF (column mdf) to use for any
particular combination of prism and decker values (columns prism and
decker).  It also defines pixel scale and the section to use for
calculating the \fIoffset\fR (columns pixscale and offsetsection).
.sp
Prism and decker are determined using the \fInsheaders.key_prism\fR and
\fInsheaders.key_decker\fR header values.
.sp
The MDF format is defined at
.sp
http://www.gemini.edu/sciops/instruments/gmos/gmosMOSobserver.html
.sp
An additional field - specorder - is used by the nifs package to
associate a particular row of the table with a cross-dispersed order.
.le
.ls specsec = "[*,*]"
If no MDF file is found via \fIconfigtable\fR then this parameter is
used to define either a section directly (if the first character is
"["), or name an appropriate MDF file.
.le
.ls pixscale = 0.043
If no MDF file is found via \fIconfigtable\fR then this parameter is
used to define the pixel scale (arcsec).
.le
.ls shiftimage = ""
An earlier image from which MDF shifts should be copied.  The \fIshiftx\fR
and \fIshifty\fR values are read from the MDF_SHFX and MDF_SHFY header
entries in the PHU.
.le
.ls shiftx  = 0, shifty  = 0
Pixel shifts for the MDF (used if \fIshiftimage\fR="").  
These values are subtracted from x_ccd and 
y_ccd in the MDF file associated with the data.
.sp
If both values are set to INDEF the shift will be estimated by
cross-correlating the MDF with the first file using the task NSOFFSET.
In this case, all files must use the same MDF.
.le
.ls obstype = "FLAT"
If cross-correlation is used to position the MDF, the list of input files 
will be searched to
find an entry for which the header entry identified by 
\fInsheaders.key_obstype\fR has the value \fIobstype\fR.  This frame will
be used (prepared first) to measure the cross-correlation.
.sp
Science data frames should be avoided if they have bright emission that
is not centred in the slit.
.sp
If no value is given, the first frame will be used.
.le
.ls fl_inter = no
Run the cross correlation for MDF shifts interactively.
.le
.ls logfile = ""
Name of logfile.  The default value makes the task use the logfile name 
defined by \fInifs.logfile\fR, or "nifs.log" if that is also not defined.
.le
.ls verbose = yes
Print verbose outputs to screen.
.le
.ls status = 0
Exit status will be non-zero if NFPREPARE halted with an error.  This 
parameter is always set by the task and should not be modified by the user.
.le
.sp
.ce
Parameters from NSHEADERS
.sp
The following values are read from GNIRS.NSHEADERS
.ls sci_ext
Name of science extension
.le
.ls var_ext
Name of variance extension
.le
.ls dq_ext
Name of data quality extension
.le
.ls key_bias
Header keyword for detector bias (V)
.le
.ls key_coadds
Header keyword for number of co-adds
.le
.ls key_dark
Header keyword to identify darks
.le
.ls key_dispaxis
Header keyword for dispersion axis
.le
.ls key_exptime 
Header keyword for exposure time
.le
.ls key_filter
Header keyword for filter
.le
.ls key_fpmask
Header keyword for focal plane mask (slit)
.le
.ls key_gain
Header keyword for gain (e-/ADU)
.le
.ls key_grating
Header keyword for grating
.le
.ls key_lnrs
Header keyword for number of non-destructive reads
.le
.ls key_mode
Header keyword for reduction mode (value will be IFU)
.le
.ls key_nonlinear
Header keyword for non-linear regime (ADU)
.le
.ls key_obstype
Header keyword for observation type
.le
.ls key_prism
Header keyword for prism
.le
.ls key_ron
Header keyword for read noise (e-)
.le
.ls key_sat
Header keyword for saturation (ADU)
.le
.ls key_section 
Header keyword for image section(s) to cut
.le
.ls key_val_dark
Substring to match against dark header value
.le
.le
.ih
DESCRIPTION
NFPREPARE prepares NIFS data for further processing within the
GEMINI.NIFS package.  Preparation includes the following steps:
.ls Validating data
The input data are checked (e.g., they must exist, be MEF format files;
the bpm, if given, must match the data size, etc.)
.le
.ls Dark detection
The PHU is checked to see whether the value of the
\fInsheaders.key_dark\fR matches \fInsheaders.val_dark\fR.  If so,
then no MDF will be attached to the data unless \fIfl_dark_mdf\fR is
set.
.le
.ls Reading array data
Header values and \fIarraytable\fR are used to define the detector
characteristics (see table description under parameter \fIarraytable\fR).  
The absolute value of the bias must be within 0.1V
of a bias level in the table.
.le
.ls Saturation and linear limit levels
The saturation level is calculated by scaling the well depth from the
array data by the number of coadds used to generate the data.  The
linear limits is then some fixed fraction of this: if the data are to
be corrected for non-linearity (\fIfl_correct\fR) then linearlimit is
used, otherwise nonlinearlimit is used (see \fIarraytable\fR).
.le
.ls Subtraction of reference pixels
The reference pixel subtraction for Hawaii 2RG detectors has been shown to
improve the noise performance by removing some of the structure in the pre-
bias corrected images.  So, this is an available option.
.le
.ls Correction for non-linearity
The science data are corrected for non-linearity using the task irlincor
and the coefficients from \fIarraytable\fR, if \fIfl_correct\fR is set.
This correction is made after correcting for offset and adjusted for
the number of coadds.
.le
.ls Calculating variance
If \fIfl_var_dq\fR is set then the variance array is calculated as 
.nf
  (read noise/gain)^2 + max(data,0.0)/gain
.fi
This calculation is made after correcting for reference pixels and 
non-linearity.
.le
.ls Calculating data quality
If \fIfl_var_dq\fR is set then the data quality values are as follows:
.nf
  0 good data
  2 data exceed linear limit
  4 data saturated
.fi
In addition, values from \fIbpm\fR are included if that parameter is
specified.  Corrected data are used (non-linearity levels from 
\fIarraytable\fR are different with and without linearity correction).
.le
.ls Detect cosmic rays and radiation events
If \fIfl_cravg\fR is set then the data quality array is modified to
reflect the presence of cosmic rays and radiation event in the data.
.le
.sp
.ce
Using NSOFFSET to align the MDF
.sp
If \fIshiftx\fR and \fIshifty\fR are both INDEF, then the task NSOFFSET
will be used to align the MDF with the first data frame that is not a 
dark (assuming \fIfl_dark_mdf-\fR).  The offset (and direction) will be
written to the log and recorded in the PHU of each processed file.
.sp
Since there is no guarantee that NSOFFSET will measure exactly the
same shift for different data, it is important to make sure that all
data are processed consistently.  The simplest way is to run NFPREPARE
on all observations in a single pass.  Alternatively, use the
automatic shift for the first set of data and then provide an image
via the \fIshiftimage\fR parameter to copy that shift on subsequent
sets (or specify the same shift by hand using \fIshiftx\fR and 
\fIshifty\fR).
.ih
EXAMPLES
1.  Prepare a NIFS data file and calculate the MDF shifts.
.sp
.nf
    ni> nfprepare N20051112S0060.fits shiftx=INDEF shifty=INDEF
.fi
.sp
2. Prepare the data in the list "files.lis", and shift the MDF to match the 
pre-determined shift file (from Example 1).
.sp
.nf
    ge> nfprepare @files.lis shiftimage="nN20051112S0060.fits"
.fi
.ih
BUGS AND LIMITATIONS
Currently, NFPREPARE does not correct for non-linearity effects in a 
consistent manner.  As a result, the default for non-linearity correction is 
set to "no".  Further work is being done on this.  Also, the flagging and
correction of cosmic rays has not been tested very thoroughly. So users should
be cautious when using cosmic ray rejection parameters.
.ih
SEE ALSO
.endhelp

